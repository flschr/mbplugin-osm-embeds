{{/*
  Privacy-friendly OpenStreetMap shortcode for Micro.blog.
  This template avoids JavaScript and works in feeds as well as on the web.
*/}}
{{- $state := newScratch -}}
{{- $state.Set "hasError" false -}}
{{- $state.Set "errorMessage" "" -}}
{{- $state.Set "zoomInt" 14 -}}
{{- $state.Set "zoomString" "14" -}}
{{- $locRaw := .Get "loc" -}}
{{- $numberPattern := `^-?\d+(\.\d+)?$` -}}
{{- if not $locRaw -}}
  {{- $state.Set "hasError" true -}}
  {{- $state.Set "errorMessage" "The map shortcode requires a \"loc\" parameter in the format latitude,longitude (e.g., 48.1351,11.5820)." -}}
{{- else -}}
  {{- $locClean := trim $locRaw " " -}}
  {{- $locParts := split $locClean "," -}}
  {{- if ne (len $locParts) 2 -}}
    {{- $state.Set "hasError" true -}}
    {{- $state.Set "errorMessage" (printf "Unable to parse \"%s\". Expected latitude,longitude with a comma separator." $locRaw) -}}
  {{- else -}}
    {{- $latString := trim (index $locParts 0) " " -}}
    {{- $lngString := trim (index $locParts 1) " " -}}
    {{- if or (not (findRE $numberPattern $latString)) (not (findRE $numberPattern $lngString)) -}}
      {{- $state.Set "hasError" true -}}
      {{- $state.Set "errorMessage" (printf "Coordinates must be decimal numbers. Received latitude=\"%s\" longitude=\"%s\"." $latString $lngString) -}}
    {{- else -}}
      {{- $latValue := float $latString -}}
      {{- $lngValue := float $lngString -}}
      {{- /* Validate coordinate ranges */ -}}
      {{- if or (lt $latValue -90.0) (gt $latValue 90.0) -}}
        {{- $state.Set "hasError" true -}}
        {{- $state.Set "errorMessage" (printf "Latitude must be between -90 and 90. Received: %s" $latString) -}}
      {{- else if or (lt $lngValue -180.0) (gt $lngValue 180.0) -}}
        {{- $state.Set "hasError" true -}}
        {{- $state.Set "errorMessage" (printf "Longitude must be between -180 and 180. Received: %s" $lngString) -}}
      {{- else -}}
        {{- $state.Set "latValue" $latValue -}}
        {{- $state.Set "lngValue" $lngValue -}}
        {{- $state.Set "latFormatted" (printf "%.6f" $latValue) -}}
        {{- $state.Set "lngFormatted" (printf "%.6f" $lngValue) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Determine zoom level based on defaults and shortcode parameters */ -}}
{{- if not ($state.Get "hasError") -}}
  {{- $defaultZoomCandidate := printf "%v" (or .Site.Params.default_map_zoom "14") -}}
  {{- if (findRE `^\d+$` $defaultZoomCandidate) -}}
    {{- $defaultZoomInt := int $defaultZoomCandidate -}}
    {{- if and (ge $defaultZoomInt 0) (le $defaultZoomInt 19) -}}
      {{- $state.Set "zoomInt" $defaultZoomInt -}}
      {{- $state.Set "zoomString" (printf "%d" $defaultZoomInt) -}}
    {{- end -}}
  {{- end -}}
  {{- with .Get "zoom" -}}
    {{- $zoomCandidate := trim . " " -}}
    {{- if (findRE `^\d+$` $zoomCandidate) -}}
      {{- $zoomValue := int $zoomCandidate -}}
      {{- if and (ge $zoomValue 0) (le $zoomValue 19) -}}
        {{- $state.Set "zoomInt" $zoomValue -}}
        {{- $state.Set "zoomString" (printf "%d" $zoomValue) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- $state.Set "osmLink" (printf "https://www.openstreetmap.org/?mlat=%.6f&mlon=%.6f#map=%s/%.6f/%.6f" ($state.Get "latValue") ($state.Get "lngValue") ($state.Get "zoomString") ($state.Get "latValue") ($state.Get "lngValue")) -}}
{{- end -}}

{{- if $state.Get "hasError" -}}
  <div class="mb-map-error">
    <strong>Map shortcode error:</strong>
    <span>{{ $state.Get "errorMessage" }}</span>
    <span>Example: {{`{{< map loc="48.1351,11.5820" zoom="14" >}}`}}</span>
  </div>
{{- else -}}
  {{- $latValue := $state.Get "latValue" -}}
  {{- $lngValue := $state.Get "lngValue" -}}
  {{- $latFormatted := $state.Get "latFormatted" -}}
  {{- $lngFormatted := $state.Get "lngFormatted" -}}
  {{- $zoomInt := $state.Get "zoomInt" -}}
  {{- $zoomString := $state.Get "zoomString" -}}
  {{- $osmLink := $state.Get "osmLink" -}}

  {{- /* Feed detection */ -}}
  {{- $mediaSubType := "" -}}
  {{- with .Page.MediaType -}}
    {{- $mediaSubType = lower .SubType -}}
  {{- end -}}
  {{- $isFeed := in (slice "rss" "json" "atom") $mediaSubType -}}

  {{- /* UI and preview configuration */ -}}
  {{- $apiKey := "" -}}
  {{- with .Site.Params.map_preview_api_key -}}
    {{- $apiKey = trim (printf "%v" .) " " -}}
  {{- end -}}
  {{- $hasPreview := and (ne $apiKey "") (ne $apiKey "<nil>") -}}

  {{- $styleLightCandidate := trim (printf "%v" (or .Site.Params.map_preview_style_light "osm-carto")) " " -}}
  {{- $styleLight := cond (ne $styleLightCandidate "") $styleLightCandidate "osm-carto" -}}

  {{- $styleDarkCandidate := trim (printf "%v" (or .Site.Params.map_preview_style_dark "osm-carto")) " " -}}
  {{- $styleDark := cond (ne $styleDarkCandidate "") $styleDarkCandidate "osm-carto" -}}

  {{- /* Marker configuration */ -}}
  {{- $markerParams := printf "%v" (or .Site.Params.map_marker_params "type:awesome;color:red;size:60;shadow:no") -}}
  {{- $markerParams = trim $markerParams " " -}}

  {{- $previewBase := "https://maps.geoapify.com/v1/staticmap" -}}
  {{- $markerQuery := printf "lonlat:%s,%s;%s" $lngFormatted $latFormatted $markerParams -}}
  {{- $lightPreview := printf "%s?style=%s&width=768&height=432&center=lonlat:%s,%s&zoom=%s&marker=%s&apiKey=%s" $previewBase (urlquery $styleLight) $lngFormatted $latFormatted $zoomString (urlquery $markerQuery) $apiKey -}}
  {{- $lightPreview2x := printf "%s?style=%s&width=1536&height=864&center=lonlat:%s,%s&zoom=%s&marker=%s&apiKey=%s" $previewBase (urlquery $styleLight) $lngFormatted $latFormatted $zoomString (urlquery $markerQuery) $apiKey -}}
  {{- $darkPreview := printf "%s?style=%s&width=768&height=432&center=lonlat:%s,%s&zoom=%s&marker=%s&apiKey=%s" $previewBase (urlquery $styleDark) $lngFormatted $latFormatted $zoomString (urlquery $markerQuery) $apiKey -}}
  {{- $darkPreview2x := printf "%s?style=%s&width=1536&height=864&center=lonlat:%s,%s&zoom=%s&marker=%s&apiKey=%s" $previewBase (urlquery $styleDark) $lngFormatted $latFormatted $zoomString (urlquery $markerQuery) $apiKey -}}

  {{- /* Privacy mode configuration */ -}}
  {{- $privacyMode := true -}}
  {{- if isset .Site.Params "privacy_mode" -}}
    {{- $modeRaw := lower (trim (printf "%v" .Site.Params.privacy_mode) " ") -}}
    {{- if in (slice "false" "0" "no") $modeRaw -}}
      {{- $privacyMode = false -}}
    {{- end -}}
  {{- end -}}

  {{- /* Privacy notice and button configuration */ -}}
  {{- $privacyNoticeText := trim (printf "%v" (or .Site.Params.map_privacy_notice_text "")) " " -}}
  {{- $showPrivacyNotice := and $privacyMode (ne $privacyNoticeText "") -}}
  {{- $buttonText := printf "%v" (or .Site.Params.map_button_text "Interactive Map") -}}
  {{- $showButton := and $privacyMode (eq $privacyNoticeText "") -}}

  {{- /* Feed output uses only the static preview or a fallback link */ -}}
  {{- if $isFeed -}}
    {{- if $hasPreview -}}
      <a href="{{ $osmLink | htmlEscape }}">
        <img src="{{ $lightPreview | safeURL }}" srcset="{{ $lightPreview | safeURL }} 1x, {{ $lightPreview2x | safeURL }} 2x" alt="Static map preview at {{ $latFormatted }}, {{ $lngFormatted }}" width="768" height="432" loading="lazy" decoding="async" />
      </a>
    {{- else -}}
      <a href="{{ $osmLink | htmlEscape }}">View this location on OpenStreetMap ({{ $latFormatted }}, {{ $lngFormatted }})</a>
    {{- end -}}
  {{- else -}}
    {{- /* Calculate bounding box for the iframe */ -}}
    {{- $zoomFloat := float $zoomInt -}}
    {{- $worldDegrees := div 360.0 (math.Pow 2.0 $zoomFloat) -}}
    {{- $widthDegrees := mul $worldDegrees (div 768.0 256.0) -}}
    {{- $heightDegrees := mul $worldDegrees (div 432.0 256.0) -}}
    {{- $halfWidth := div $widthDegrees 2.0 -}}
    {{- $halfHeight := div $heightDegrees 2.0 -}}
    {{- $rawLeft := sub $lngValue $halfWidth -}}
    {{- $rawRight := add $lngValue $halfWidth -}}
    {{- $rawBottom := sub $latValue $halfHeight -}}
    {{- $rawTop := add $latValue $halfHeight -}}
    {{- $left := math.Max -180.0 (math.Min 180.0 $rawLeft) -}}
    {{- $right := math.Max -180.0 (math.Min 180.0 $rawRight) -}}
    {{- $bottom := math.Max -85.051129 (math.Min 85.051129 $rawBottom) -}}
    {{- $top := math.Max -85.051129 (math.Min 85.051129 $rawTop) -}}
    {{- $leftFormatted := printf "%.6f" $left -}}
    {{- $rightFormatted := printf "%.6f" $right -}}
    {{- $bottomFormatted := printf "%.6f" $bottom -}}
    {{- $topFormatted := printf "%.6f" $top -}}
    {{- $iframeURL := printf "https://www.openstreetmap.org/export/embed.html?bbox=%s,%s,%s,%s&layer=mapnik&marker=%s,%s" $leftFormatted $bottomFormatted $rightFormatted $topFormatted $latFormatted $lngFormatted -}}

    {{- /* Ensure unique IDs per page */ -}}
    {{- $page := .Page -}}
    {{- $mapCount := add (or ($page.Scratch.Get "mb-map-count") 0) 1 -}}
    {{- $page.Scratch.Set "mb-map-count" $mapCount -}}
    {{- $toggleID := printf "mb-map-toggle-%d" $mapCount -}}

    {{- if not ($page.Scratch.Get "mb-map-style-loaded") -}}
      {{- $page.Scratch.Set "mb-map-style-loaded" true -}}
      <style>
        .mb-map-wrapper {
          position: relative;
          display: grid;
          gap: 0.75rem;
          max-width: 48rem;
          margin: 0 auto 2rem auto;
          font-family: var(--map-font-family, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
          border-radius: var(--map-border-radius, var(--img-border-radius, 0.5rem));
        }
        .mb-map-toggle {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0 0 0 0);
          clip-path: inset(50%);
          border: 0;
        }
        .mb-map-preview {
          position: relative;
          overflow: hidden;
          border-radius: inherit;
        }
        .mb-map-loading-placeholder {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          aspect-ratio: 16 / 9;
          background: #f3f4f6;
          color: #6b7280;
          font-size: 1rem;
          border-radius: inherit;
        }
        .mb-map-preview-content {
          display: none;
        }
        .mb-map-preview-content.loaded {
          display: block;
        }
        .mb-map-preview label {
          display: block;
          cursor: pointer;
          position: relative;
          border-radius: inherit;
        }
        .mb-map-preview label::before {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0);
          transition: background 0.2s ease;
          pointer-events: none;
          border-radius: inherit;
        }
        .mb-map-preview:not(.mb-map-preview--with-button) label:hover::before {
          background: rgba(0, 0, 0, 0.15);
        }
        .mb-map-preview picture,
        .mb-map-preview img {
          display: block;
          width: 100%;
          height: auto;
          border-radius: inherit;
        }
        .mb-map-privacy-notice {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          background: rgba(0, 0, 0, 0.75);
          color: #ffffff;
          padding: 0.75rem 1rem;
          font-size: 0.875rem;
          font-weight: normal;
          line-height: 1.4;
          text-align: center;
          border-bottom-left-radius: inherit;
          border-bottom-right-radius: inherit;
        }
        .mb-map-overlay {
          position: absolute;
          bottom: 1.5rem;
          right: 1.5rem;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .mb-map-preview--with-notice .mb-map-overlay {
          bottom: 4rem;
        }
        .mb-map-overlay .button {
          display: inline-block;
          padding: 0.75rem 1.5rem;
          background: #2563eb;
          color: #ffffff;
          font-size: 1rem;
          font-weight: 600;
          border-radius: 0.5rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          transition: all 0.2s ease;
          pointer-events: none;
        }
        .mb-map-preview label:hover .button {
          background: #ffffff;
          color: #2563eb;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .mb-map-preview label:active .button {
          background: #f0f9ff;
          color: #1d4ed8;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .mb-map-preview label:focus-visible {
          outline: 3px solid rgba(14, 165, 233, 0.75);
          outline-offset: 4px;
        }
        .mb-map-canvas {
          display: block;
          overflow: hidden;
        }
        .mb-map-canvas iframe {
          border: 0;
          width: 100%;
          aspect-ratio: 16 / 9;
        }
        .mb-map-toggle ~ .mb-map-canvas {
          display: none;
        }
        .mb-map-toggle:checked ~ .mb-map-preview {
          display: none;
        }
        .mb-map-toggle:checked ~ .mb-map-canvas {
          display: block;
        }
        .mb-map-hint {
          margin: 0;
          padding: 0.85rem 1rem;
          background: #eff6ff;
          color: #1e3a8a;
          font-size: 0.95rem;
          line-height: 1.4;
        }
        .mb-map-error {
          margin: 1.5rem 0;
          padding: 1rem 1.25rem;
          background: #fee2e2;
          color: #991b1b;
          display: grid;
          gap: 0.5rem;
        }
        @media (prefers-color-scheme: dark) {
          .mb-map-hint {
            background: #1f2937;
            color: #f3f4f6;
          }
          .mb-map-loading-placeholder {
            background: #1f2937;
            color: #9ca3af;
          }
        }
      </style>
    {{- end -}}

    {{- if not ($page.Scratch.Get "mb-map-loading-script-loaded") -}}
      {{- $page.Scratch.Set "mb-map-loading-script-loaded" true -}}
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          document.querySelectorAll('.mb-map-preview-content').forEach(function(content) {
            var img = content.querySelector('img');
            if (img) {
              if (img.complete && img.naturalHeight !== 0) {
                content.classList.add('loaded');
                var placeholder = content.previousElementSibling;
                if (placeholder && placeholder.classList.contains('mb-map-loading-placeholder')) {
                  placeholder.style.display = 'none';
                }
              } else {
                img.addEventListener('load', function() {
                  content.classList.add('loaded');
                  var placeholder = content.previousElementSibling;
                  if (placeholder && placeholder.classList.contains('mb-map-loading-placeholder')) {
                    placeholder.style.display = 'none';
                  }
                });
              }
            }
          });
        });
      </script>
    {{- end -}}

    <div class="mb-map-wrapper">
      {{- if and $hasPreview $privacyMode -}}
        {{- /* With API key and privacy mode: show preview with toggle */ -}}
        <input type="checkbox" id="{{ $toggleID }}" class="mb-map-toggle" />
        <div class="mb-map-preview{{ if $showPrivacyNotice }} mb-map-preview--with-notice{{ end }}{{ if $showButton }} mb-map-preview--with-button{{ end }}">
          <div class="mb-map-loading-placeholder">Loading map preview...</div>
          <div class="mb-map-preview-content">
            <label for="{{ $toggleID }}">
              <picture>
                <source media="(prefers-color-scheme: dark)" srcset="{{ $darkPreview | safeURL }} 1x, {{ $darkPreview2x | safeURL }} 2x" />
                <source media="(prefers-color-scheme: light)" srcset="{{ $lightPreview | safeURL }} 1x, {{ $lightPreview2x | safeURL }} 2x" />
                <img src="{{ $lightPreview | safeURL }}" srcset="{{ $lightPreview | safeURL }} 1x, {{ $lightPreview2x | safeURL }} 2x" alt="Static map preview at {{ $latFormatted }}, {{ $lngFormatted }}" width="768" height="432" loading="lazy" decoding="async" />
              </picture>
              {{- if $showPrivacyNotice -}}
                <div class="mb-map-privacy-notice">{{ $privacyNoticeText }}</div>
              {{- end -}}
              {{- if $showButton -}}
                <div class="mb-map-overlay">
                  <span class="button">{{ $buttonText }}</span>
                </div>
              {{- end -}}
            </label>
          </div>
        </div>
        <div class="mb-map-canvas">
          <iframe src="{{ $iframeURL | safeURL }}" loading="lazy" referrerpolicy="no-referrer" allowfullscreen title="OpenStreetMap map view" aria-label="Interactive OpenStreetMap view for {{ $latFormatted }}, {{ $lngFormatted }}"></iframe>
        </div>
      {{- else -}}
        {{- /* Without API key or privacy mode disabled: show map directly */ -}}
        <div class="mb-map-canvas">
          <iframe src="{{ $iframeURL | safeURL }}" loading="lazy" referrerpolicy="no-referrer" allowfullscreen title="OpenStreetMap map view" aria-label="Interactive OpenStreetMap view for {{ $latFormatted }}, {{ $lngFormatted }}"></iframe>
        </div>
      {{- end -}}
    </div>
  {{- end -}}
{{- end -}}
